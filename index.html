<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIWI智能排版系统 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@7.5.0/build/index.js"></script>

    <style>
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            .print-hidden { display: none !important; }
        }
        .font-song { font-family: "SimSun", "宋体", serif; }
        
        .preview-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 1em 0; 
            font-size: 14px; 
            border: 2px solid #000; 
            table-layout: auto;
        }
        .preview-table td, .preview-table th { 
            border: 1px solid #000; 
            padding: 8px; 
            text-align: center; 
            vertical-align: middle;
            word-wrap: break-word;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 5px; border: 2px solid #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ path }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={path} /></svg>;
        const paths = {
            upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
            file: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6",
            trash: "M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
            download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            check: "M20 6L9 17l-5-5"
        };

        function App() {
            const [activeTab, setActiveTab] = useState('text'); 
            const [inputText, setInputText] = useState('');
            const [content, setContent] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [docName, setDocName] = useState("公文");

            const SPECS = {
                margins: { top: '37mm', bottom: '35mm', left: '28mm', right: '26mm' },
                lineHeightBody: 560, // 28磅
                lineHeightHeader: 640, // 32磅
                fonts: {
                    title: '"FZXiaoBiaoSong-B05S", "方正小标宋简体", "SimSun", serif', 
                    h1: '"SimHei", "黑体", sans-serif',                              
                    h2: '"KaiTi_GB2312", "KaiTi", "楷体", serif',                    
                    h3: '"FangSong_GB2312", "FangSong", "仿宋", serif',              
                    body: '"FangSong_GB2312", "FangSong", "仿宋", serif',            
                    pageNo: '"SimSun", "宋体", serif'
                },
                sizes: { title: '22pt', header: '16pt', body: '16pt', page: '14pt' }
            };

            const parseTextTables = (lines) => {
                let parsedBlocks = [];
                let currentTableBuffer = [];
                const isTableLine = (str) => { if (str.includes('\t')) return true; return str.trim().split(/\s{2,}/).length > 1; };
                const flushTableBuffer = () => {
                    if (currentTableBuffer.length > 0) {
                        const tableData = currentTableBuffer.map(rowStr => {
                            let cells = rowStr.includes('\t') ? rowStr.split('\t') : rowStr.split(/\s{2,}/);
                            return cells.map(c => ({ text: c.trim(), rowSpan: 1, colSpan: 1 }));
                        });
                        parsedBlocks.push({ type: 'table', data: tableData });
                        currentTableBuffer = [];
                    }
                };
                lines.forEach(line => {
                    if (isTableLine(line)) currentTableBuffer.push(line);
                    else { flushTableBuffer(); if (line.trim()) parsedBlocks.push({ type: 'text', text: line }); }
                });
                flushTableBuffer();
                return parsedBlocks;
            };

            const aiCleanerEngine = (inputBlocks) => {
                let rawBlocks = [];

                if (typeof inputBlocks === 'string') {
                    let cleanText = inputBlocks
                        .replace(/^(好的|明白了|Sure|Here is|Certainly|以下是|根据您的要求).+?(\n|$)/i, '') 
                        .replace(/^[#]+ /gm, '').replace(/\*\*(.*?)\*\*/g, '$1').replace(/^[-*_]{3,}\s*$/gm, '') 
                        .replace(/^\s*[-—]*\s*\d+\s*[-—]*\s*$/gm, '').replace(/^\s*Page\s*\d+\s*$/gmi, '').replace(/\(页码：.*?\)/g, '');
                    let formattedText = "";
                    let quoteState = false; 
                    for (let char of cleanText) {
                        if (char === '"') { formattedText += quoteState ? '”' : '“'; quoteState = !quoteState; } else formattedText += char;
                    }
                    const lines = formattedText.split(/\n+/).map(t => t.trim()).filter(t => t);
                    rawBlocks = parseTextTables(lines);
                } else {
                    rawBlocks = inputBlocks.map(b => {
                        if (b.type === 'table') return b; 
                        let t = b.text.replace(/^\s*[-—]*\s*\d+\s*[-—]*\s*$/g, '').replace(/^\s*Page\s*\d+\s*$/gi, '');
                        if (!t.trim()) return null;
                        let formatted = ""; let q = false;
                        for (let char of t) { if (char === '"') { formatted += q ? '”' : '“'; q = !q; } else formatted += char; }
                        return { type: 'text', text: formatted.trim() };
                    }).filter(b => b);
                }

                let processed = [];
                let titleLineCount = 0;
                let level1Counter = 0; 
                let level2Counter = 0; 
                let level3Counter = 0; 
                const toChiNum = (n) => ['一','二','三','四','五','六','七','八','九','十'][n-1] || n;
                
                let detectedTitleParts = [];

                const isTitleLine = (block, idx) => {
                    if (block.type !== 'text') return false;
                    const text = block.text.trim();
                    if (idx > 5) return false; 
                    if (text.length > 80) return false; 
                    if (/[。；;!！]$/.test(text)) return false; 
                    if (/^[一二三四五六七八九十]+、/.test(text)) return false; 
                    if (/^[（(].{2,10}[）)]$/.test(text)) return true;
                    const keywords = ['公司', '通知', '报告', '总结', '计划', '规划', '纲要', '意见', '方案', '办法', '规定', '细则', '章程', '汇报', '纪要', '讲话', '函', '请示', '批复', '调研'];
                    if (keywords.some(kw => text.includes(kw))) return true;
                    if (text.startsWith('关于')) return true;
                    if (idx === 0 && text.length < 50) return true;
                    if (idx < 3 && text.length < 30) return true;
                    return false;
                };

                const isDataTable = (tableBlock) => {
                    let numberCount = 0;
                    let totalCells = 0;
                    let hasLayoutKeywords = false;

                    tableBlock.data.forEach(row => {
                        row.forEach(cell => {
                            totalCells++;
                            const txt = cell.text.trim();
                            if (/^第\s*[一二三四五六七八九十0-9]+\s*部分/.test(txt) || 
                                /(工作总结|工作计划|汇报|年度|半年度|月份|季度)/.test(txt) ||
                                /(^|\s)(党建|行政|思想|组织|纪律|作风)(部分|篇|章)($|\s)/.test(txt)) {
                                hasLayoutKeywords = true;
                            }
                            const cleanTxt = txt.replace(/\d{4}年/g, '').replace(/\d{1,2}月/g, '').replace(/\d{1,2}日/g, '');
                            if (/\d/.test(cleanTxt) && cleanTxt.length < 10) {
                                numberCount++;
                            }
                        });
                    });

                    if (hasLayoutKeywords) return false; 
                    if (tableBlock.data.length === 1 && numberCount === 0) return false;
                    return (numberCount / totalCells > 0.2) || totalCells > 12;
                };

                rawBlocks.forEach((block, index) => {
                    // 表格处理
                    if (block.type === 'table') {
                        if (isDataTable(block)) {
                            processed.push(block); 
                        } else {
                            // 拆箱重构：
                            block.data.forEach(row => {
                                row.forEach(cell => {
                                    const txt = cell.text.trim();
                                    if (txt) {
                                        const isSectionHeader = /^第[一二三四五六七八九十0-9]+部分$/.test(txt) || /^(党建|行政)部分$/.test(txt);
                                        if (isSectionHeader) {
                                            processed.push({ type: 'section_header', text: txt });
                                            level1Counter = 0; level2Counter = 0; level3Counter = 0;
                                        } else {
                                            processed.push({ type: 'no_indent_body', text: txt });
                                        }
                                    }
                                });
                            });
                        }
                        return;
                    }

                    const line = block.text;

                    if (index === titleLineCount && isTitleLine(block, index)) { 
                        processed.push({ type: 'title', text: line }); 
                        detectedTitleParts.push(line);
                        titleLineCount++; 
                        return; 
                    }

                    if (/^(第一部分|第二部分|第三部分|第四部分|党建部分|行政部分|附件)[:：]?/.test(line)) { 
                        level1Counter = 0; level2Counter = 0; level3Counter = 0;
                        processed.push({ type: 'section_header', text: line }); 
                        return; 
                    }
                    
                    if (index > rawBlocks.length - 6 && (/\d{4}年\d{1,2}月\d{1,2}日$/.test(line) || line.startsWith('学员') || line.startsWith('汇报人') || line.startsWith('落款'))) { 
                        processed.push({ type: 'signature_date', text: line }); 
                        return; 
                    }
                    
                    let isLevel1 = false, isLevel2 = false, isLevel3 = false;
                    let contentText = line;

                    if (/^[一二三四五六七八九十]+、/.test(line)) { 
                        isLevel1 = true; 
                        contentText = line.replace(/^[一二三四五六七八九十]+、\s*/, ''); 
                    }
                    else if (/^[(（][一二三四五六七八九十]+[)）]/.test(line)) { 
                        isLevel2 = true; 
                        contentText = line.replace(/^[(（][一二三四五六七八九十]+[)）]\s*/, ''); 
                    }
                    else if (/^\d+[.．、]\s*/.test(line)) { 
                        contentText = line.replace(/^\d+[.．、]\s*/, ''); 
                        if (level2Counter > 0) { isLevel3 = true; } 
                        else if (level1Counter > 0) { isLevel2 = true; } 
                        else { isLevel1 = true; }
                    }
                    
                    if (isLevel1) { 
                        level1Counter++; level2Counter = 0; level3Counter = 0;
                        processed.push({ type: 'h1', text: `${toChiNum(level1Counter)}、${contentText}` }); 
                        return; 
                    }
                    if (isLevel2) { 
                        level2Counter++; level3Counter = 0;
                        processed.push({ type: 'h2', text: `（${toChiNum(level2Counter)}）${contentText}` }); 
                        return; 
                    }
                    if (isLevel3) {
                        level3Counter++;
                        processed.push({ type: 'h3', text: `${level3Counter}. ${contentText}` });
                        return;
                    }

                    processed.push({ type: 'body', text: line });
                });
                
                // 后处理：合并连续的章节标题 + 控制空行
                const finalProcessed = [];
                let skipNext = false;

                for (let i = 0; i < processed.length; i++) {
                    if (skipNext) { skipNext = false; continue; }

                    const current = processed[i];
                    const next = processed[i+1];

                    // 1. 合并 "第一部分" + "标题"
                    if (current.type === 'section_header' && /^第[一二三四五六七八九十0-9]+部分$/.test(current.text.trim())) {
                        if (next && (next.type === 'section_header' || next.type === 'body' || next.type === 'no_indent_body')) {
                            if (next.text.length < 50) {
                                current.text = current.text + " " + next.text;
                                skipNext = true;
                            }
                        }
                    }
                    
                    finalProcessed.push(current);
                    
                    // 2. 空行规则：只在【大标题块】完全结束后，插入一个空行
                    // 逻辑：如果当前是标题，且下一行 *不是* 标题，则插入空行
                    if (current.type === 'title') {
                        if (next && next.type !== 'title' && next.type !== 'empty_line') {
                            finalProcessed.push({ type: 'empty_line' });
                        }
                    }
                    // 注意：这里删除了之前版本中自动给 SectionHeader 和 H1 前面加空行的逻辑
                }
                
                if (finalProcessed.length > 0 && finalProcessed[0].type !== 'title') {
                    finalProcessed.unshift({ type: 'title', text: '公文文件' });
                    finalProcessed.splice(1, 0, { type: 'empty_line' });
                }
                
                if (detectedTitleParts.length > 0) {
                    const fullTitle = detectedTitleParts.join("").replace(/[\\/:*?"<>|]/g, "").substring(0, 50);
                    setDocName(fullTitle);
                } else {
                    setDocName("公文文件");
                }

                return finalProcessed;
            };

            const handleProcess = () => {
                if (!inputText.trim()) return;
                setIsProcessing(true);
                setTimeout(() => {
                    const formatted = aiCleanerEngine(inputText);
                    setContent(formatted);
                    setIsProcessing(false);
                }, 500);
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsProcessing(true);
                try {
                    const buffer = await file.arrayBuffer();
                    const result = await window.mammoth.convertToHtml({ arrayBuffer: buffer });
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.value, 'text/html');
                    const blocks = [];
                    const extractNodes = (nodes) => {
                        nodes.forEach(node => {
                            if (node.nodeName === 'TABLE') {
                                const rows = Array.from(node.querySelectorAll('tr')).map(tr => {
                                    return Array.from(tr.querySelectorAll('td, th')).map(td => ({
                                        text: td.innerText.trim(),
                                        rowSpan: parseInt(td.getAttribute('rowspan') || '1'),
                                        colSpan: parseInt(td.getAttribute('colspan') || '1')
                                    }));
                                });
                                if (rows.length > 0 && rows[0].length > 0) blocks.push({ type: 'table', data: rows });
                            } else if (['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'LI'].includes(node.nodeName)) {
                                const text = node.innerText.trim();
                                if (text) blocks.push({ type: 'text', text: text });
                            } else if (node.childNodes.length > 0) extractNodes(node.childNodes);
                        });
                    };
                    extractNodes(doc.body.childNodes);
                    const formatted = aiCleanerEngine(blocks);
                    setContent(formatted);
                } catch (err) { console.error(err); alert("解析失败"); } 
                finally { setIsProcessing(false); }
            };

            const generateDocx = () => {
                if (!window.docx || content.length === 0) return;
                const { Document, Packer, Paragraph, TextRun, AlignmentType, Footer, PageNumber, Table, TableRow, TableCell, WidthType, BorderStyle, VerticalAlign, TableLayoutType } = window.docx;
                
                const doc = new Document({
                    styles: { paragraphStyles: [{ id: "Normal", name: "Normal", run: { font: "仿宋_GB2312", size: 32 }, paragraph: { spacing: { line: SPECS.lineHeightBody, lineRule: "exact" }, alignment: AlignmentType.JUSTIFIED } }] },
                    sections: [{
                        properties: { page: { margin: { top: "37mm", bottom: "35mm", left: "28mm", right: "26mm" } } },
                        footers: { default: new Footer({ children: [new Paragraph({ alignment: AlignmentType.CENTER, children: [ new TextRun({ text: "— ", font: "宋体", size: 28 }), new TextRun({ children: [PageNumber.CURRENT], font: "宋体", size: 28 }), new TextRun({ text: " —", font: "宋体", size: 28 }) ] })] }) },
                        children: content.map(block => {
                            if (block.type === 'table') {
                                return new Table({
                                    width: { size: 100, type: WidthType.PERCENTAGE },
                                    layout: TableLayoutType.AUTOFIT,
                                    rows: block.data.map((row) => new TableRow({ children: row.map(cell => new TableCell({ children: [new Paragraph({ text: cell.text, style: "Normal", alignment: AlignmentType.CENTER })], columnSpan: cell.colSpan, rowSpan: cell.rowSpan, verticalAlign: VerticalAlign.CENTER, borders: { top: { style: BorderStyle.SINGLE, size: 1, color: "000000" }, bottom: { style: BorderStyle.SINGLE, size: 1, color: "000000" }, left: { style: BorderStyle.SINGLE, size: 1, color: "000000" }, right: { style: BorderStyle.SINGLE, size: 1, color: "000000" } } })) }))
                                });
                            }
                            
                            if (block.type === 'empty_line') {
                                return new Paragraph({ text: "", spacing: { line: SPECS.lineHeightBody, lineRule: "exact" } }); 
                            }

                            let runCfg = { text: block.text, size: 32, font: "仿宋_GB2312" };
                            let paraCfg = { spacing: { line: SPECS.lineHeightBody, lineRule: "exact", before: 0, after: 0 }, indent: { firstLine: 640 }, alignment: AlignmentType.JUSTIFIED };
                            
                            switch(block.type) {
                                case 'title': 
                                    runCfg = { text: block.text, size: 44, font: "方正小标宋简体" }; 
                                    runCfg.bold = false; 
                                    paraCfg = { alignment: AlignmentType.CENTER, spacing: { line: SPECS.lineHeightHeader, lineRule: "exact" }, indent: { firstLine: 0 } }; 
                                    break;
                                case 'section_header': 
                                    runCfg = { text: block.text, size: 32, font: "黑体" }; 
                                    runCfg.bold = false; 
                                    paraCfg = { alignment: AlignmentType.CENTER, indent: { firstLine: 0 }, spacing: { line: SPECS.lineHeightHeader, lineRule: "exact" } }; 
                                    break;
                                case 'h1': 
                                    runCfg.font = "黑体"; 
                                    runCfg.bold = false; 
                                    paraCfg.spacing = { line: SPECS.lineHeightHeader, lineRule: "exact" }; 
                                    break;
                                case 'h2': 
                                    runCfg.font = "楷体_GB2312"; 
                                    runCfg.bold = false; 
                                    paraCfg.spacing = { line: SPECS.lineHeightHeader, lineRule: "exact" };
                                    break;
                                case 'h3': 
                                    runCfg.font = "仿宋_GB2312"; 
                                    runCfg.bold = false; 
                                    break; 
                                case 'signature_date': 
                                    paraCfg = { alignment: AlignmentType.RIGHT, indent: { right: 800 }, spacing: { line: SPECS.lineHeightBody, lineRule: "exact" } }; 
                                    break;
                                case 'no_indent_body': 
                                    paraCfg = { alignment: AlignmentType.LEFT, indent: { firstLine: 0 }, spacing: { line: SPECS.lineHeightBody, lineRule: "exact" } }; 
                                    break;
                            }
                            return new Paragraph({ children: [new TextRun(runCfg)], ...paraCfg });
                        })
                    }]
                });
                Packer.toBlob(doc).then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a"); document.body.appendChild(a); a.style = "display: none"; a.href = url; 
                    a.download = `${docName}_公文格式化.docx`; 
                    a.click(); window.URL.revokeObjectURL(url);
                });
            };

            return (
                <div className="flex flex-col h-full">
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm shrink-0 print-hidden">
                        <div className="flex items-center gap-3">
                            <div className="bg-red-600 text-white p-2 rounded"><Icon path={paths.file} /></div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-900">KIWI智能排版系统 Pro</h1>
                                <p className="text-xs text-gray-500">严控空行 · 智能合并 · 1:1还原</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={() => {setInputText(''); setContent([]);}} className="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded border"><span className="flex items-center gap-1"><Icon path={paths.trash} /> 清空</span></button>
                             {content.length > 0 && <button onClick={generateDocx} className="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded shadow flex items-center gap-1"><Icon path={paths.download} /> 下载 Word</button>}
                        </div>
                    </header>

                    <main className="flex-1 w-full max-w-[1600px] mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-hidden">
                        <div className="flex flex-col gap-4 print-hidden h-full min-h-0">
                            <div className="flex bg-white p-1 rounded-lg border shadow-sm shrink-0">
                                <button onClick={() => setActiveTab('text')} className={`flex-1 py-2 text-sm font-medium rounded transition ${activeTab==='text' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>文字输入</button>
                                <button onClick={() => setActiveTab('upload')} className={`flex-1 py-2 text-sm font-medium rounded transition ${activeTab==='upload' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>Word版本上传</button>
                            </div>
                            <div className="flex-1 bg-white rounded-xl border shadow-sm overflow-hidden flex flex-col min-h-0">
                                {activeTab === 'text' ? (
                                    <div className="flex-1 flex flex-col p-4 h-full min-h-0">
                                        <textarea className="flex-1 w-full p-3 resize-none outline-none text-sm border rounded focus:border-blue-300 focus:bg-blue-50/20 custom-scroll" placeholder="请在此粘贴... &#10;系统会自动识别文字，并对包含数据的区域生成表格。" value={inputText} onChange={e => setInputText(e.target.value)} />
                                        <div className="mt-4 flex justify-end shrink-0"><button onClick={handleProcess} disabled={!inputText.trim() || isProcessing} className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded shadow flex items-center gap-2 transition">{isProcessing ? '处理中...' : '一键智能排版'}</button></div>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center p-8 bg-gray-50 h-full">
                                        <label className="cursor-pointer flex flex-col items-center gap-4 group">
                                            <input type="file" accept=".docx" onChange={handleFileUpload} className="hidden" />
                                            <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center group-hover:scale-110 transition"><Icon path={paths.upload} /></div>
                                            <div className="text-center text-gray-600"><p className="font-medium">点击上传 Word 版本</p><p className="text-xs mt-1">智能识别：数据表格保留，排版表格自动拆解</p></div>
                                        </label>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex flex-col gap-4 h-full min-h-0">
                            <div className="flex justify-between items-center px-1 shrink-0"><h2 className="text-sm font-bold text-gray-700 flex gap-2"><Icon path={paths.file} /> 效果预览</h2>{content.length > 0 && <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded flex gap-1"><Icon path={paths.check} /> 排版完成</span>}</div>
                            <div className="flex-1 bg-gray-200/50 rounded-xl overflow-auto custom-scroll shadow-inner p-8 block">
                                {content.length > 0 ? (
                                    <div className="bg-white shadow-xl transition-all shrink-0 mx-auto" style={{ width: '210mm', minHeight: '297mm', padding: `${SPECS.margins.top} ${SPECS.margins.right} ${SPECS.margins.bottom} ${SPECS.margins.left}`, position: 'relative' }}>
                                        {content.map((block, i) => {
                                            if (block.type === 'table') {
                                                return (
                                                    <div key={i} className="w-full mb-4 overflow-x-auto">
                                                        <table className="preview-table">
                                                            <tbody>
                                                                {block.data.map((row, rIdx) => (
                                                                    <tr key={rIdx}>{row.map((cell, cIdx) => (
                                                                        <td key={cIdx} colSpan={cell.colSpan} rowSpan={cell.rowSpan}>{cell.text}</td>
                                                                    ))}</tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                );
                                            }
                                            // 预览空行
                                            if (block.type === 'empty_line') {
                                                return <div key={i} style={{ height: '28pt' }}></div>;
                                            }

                                            const styles = {
                                                title: { fontFamily: SPECS.fonts.title, fontSize: SPECS.sizes.title, textAlign: 'center', lineHeight: '1.5', marginBottom: '0' },
                                                section_header: { fontFamily: SPECS.fonts.h1, fontSize: SPECS.sizes.header, textAlign: 'center', lineHeight: SPECS.lineHeightHeader + 'twips', marginTop: '0', marginBottom: '0', fontWeight: 'bold' },
                                                h1: { fontFamily: SPECS.fonts.h1, fontSize: SPECS.sizes.header, lineHeight: SPECS.lineHeightHeader + 'twips', textIndent: '2em', marginTop: '0', marginBottom: '0' },
                                                h2: { fontFamily: SPECS.fonts.h2, fontSize: SPECS.sizes.header, lineHeight: SPECS.lineHeightHeader + 'twips', textIndent: '2em', marginTop: '0', marginBottom: '0' },
                                                h3: { fontFamily: SPECS.fonts.h3, fontSize: SPECS.sizes.header, lineHeight: SPECS.lineHeightBody + 'twips', textIndent: '2em', marginTop: '0', marginBottom: '0' }, 
                                                body: { fontFamily: SPECS.fonts.body, fontSize: SPECS.sizes.body, lineHeight: SPECS.lineHeightBody + 'twips', textIndent: '2em', textAlign: 'justify', wordBreak: 'break-all' },
                                                no_indent_body: { fontFamily: SPECS.fonts.body, fontSize: SPECS.sizes.body, lineHeight: SPECS.lineHeightBody + 'twips', textIndent: '0', textAlign: 'left', wordBreak: 'break-all', marginBottom: '0.5em' },
                                                signature_date: { fontFamily: SPECS.fonts.body, fontSize: SPECS.sizes.body, lineHeight: SPECS.lineHeightBody + 'twips', textAlign: 'right', marginTop: '1em', marginRight: '4em' }
                                            };
                                            
                                            // 预览时的行高模拟
                                            const lineHeightPx = (block.type === 'h1' || block.type === 'h2' || block.type === 'section_header' || block.type === 'title') ? '42px' : '37px';
                                            const finalStyle = { ...styles[block.type] || styles.body, lineHeight: lineHeightPx };

                                            return <div key={i} style={finalStyle}>{block.text}</div>;
                                        })}
                                        <div className="absolute bottom-[20mm] left-0 w-full text-center text-sm font-serif text-gray-400 pointer-events-none" style={{ fontFamily: SPECS.fonts.pageNo }}>(预览页码：— 1 —)</div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center text-gray-400 h-full"><Icon path={paths.file} /><p className="text-sm mt-2">准备就绪</p></div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
